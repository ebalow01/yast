<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YieldMax ETFs - Weekly Distribution Analysis Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4caf50, #81c784);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .timestamp {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 25px;
            display: inline-block;
            font-size: 0.9rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #4caf50, #81c784);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .card-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ticker {
            font-weight: 700;
            font-size: 1.1rem;
            color: #81c784;
        }

        .positive {
            color: #4caf50;
            font-weight: 600;
        }

        .negative {
            color: #f48fb1;
            font-weight: 600;
        }

        .strategy-chip {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .dc-chip {
            background: #339af0;
            color: white;
        }

        .bh-chip {
            background: #ff6b6b;
            color: white;
        }

        .risk-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .allocation-list {
            margin-top: 20px;
        }

        .allocation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .allocation-name {
            font-weight: 600;
            color: #81c784;
        }

        .allocation-percent {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #4caf50;
        }

        th.sorted-asc::after {
            content: ' ‚ñ≤';
            color: #4caf50;
        }

        th.sorted-desc::after {
            content: ' ‚ñº';
            color: #4caf50;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>YieldMax ETFs</h1>
            <div class="subtitle">Weekly Distribution Analysis</div>
            <div class="timestamp">Last Updated: July 17, 2025</div>
        </header>

        <div class="main-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Top Performing ETFs</div>
                </div>
                <p style="opacity: 0.8; margin-bottom: 20px;">
                    ETFs with annualized returns above 40% and risk below 40% (best of Buy & Hold or Dividend Capture strategies)
                </p>
                
                <div class="table-container">
                    <table id="top-performers">
                        <thead>
                            <tr>
                                <th data-column="ticker">Ticker</th>
                                <th data-column="exDivDay">Ex-Div</th>
                                <th data-column="buyHoldReturn">B&H Return</th>
                                <th data-column="divCaptureReturn">DC Return</th>
                                <th data-column="bestStrategy">Best</th>
                                <th data-column="bestReturn">Best Return</th>
                                <th data-column="dcWinRate">Win Rate</th>
                                <th data-column="riskVolatility">Risk</th>
                                <th data-column="medianDividend">Median Div</th>
                            </tr>
                        </thead>
                        <tbody id="top-performers-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="mpt-widget" class="card" style="display: none;">
                <div class="card-header">
                    <div class="card-icon">‚öñÔ∏è</div>
                    <div class="card-title">Optimal Allocation</div>
                </div>
                
                <div class="allocation-list" id="portfolio-allocation">
                    <!-- Will be populated by JavaScript -->
                </div>

                <div class="stats-grid" id="portfolio-metrics">
                    <!-- Will be populated by JavaScript -->
                </div>

                <p style="text-align: center; margin-top: 20px; font-size: 0.85rem; opacity: 0.7;">
                    Optimization based on Sharpe ratios, efficient frontier analysis, and mean variance optimization
                </p>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Fallback data in case fetch fails
        const fallbackData = [
            {"ticker":"YMAX","tradingDays":42,"exDivDay":"Thursday","buyHoldReturn":0.9603,"divCaptureReturn":0.9940000000000001,"bestStrategy":"DC","bestReturn":0.9940000000000001,"finalValue":199396.0,"dcWinRate":0.929,"riskVolatility":0.266,"medianDividend":0.172,"category":"top-performers"},
            {"ticker":"YMAG","tradingDays":42,"exDivDay":"Thursday","buyHoldReturn":0.6598,"divCaptureReturn":0.7533,"bestStrategy":"DC","bestReturn":0.7533,"finalValue":175329.0,"dcWinRate":0.857,"riskVolatility":0.255,"medianDividend":0.158,"category":"top-performers"},
            {"ticker":"ULTY","tradingDays":17,"exDivDay":"Thursday","buyHoldReturn":0.6293,"divCaptureReturn":0.4411,"bestStrategy":"B&H","bestReturn":0.6293,"finalValue":162929.0,"dcWinRate":0.882,"riskVolatility":0.334,"medianDividend":0.065,"category":"top-performers"},
            {"ticker":"CHPY","tradingDays":25,"exDivDay":"Thursday","buyHoldReturn":0.4451,"divCaptureReturn":0.20660000000000002,"bestStrategy":"B&H","bestReturn":0.4451,"finalValue":144505.0,"dcWinRate":0.76,"riskVolatility":0.196,"medianDividend":0.382,"category":"top-performers"},
            {"ticker":"IWMY","tradingDays":25,"exDivDay":"Thursday","buyHoldReturn":0.4364,"divCaptureReturn":0.40329999999999995,"bestStrategy":"B&H","bestReturn":0.4364,"finalValue":143641.0,"dcWinRate":0.88,"riskVolatility":0.186,"medianDividend":0.275,"category":"top-performers"}
        ];

        // Load and display the performance data
        fetch('./yast-react/public/data/performance_data.json?v=' + Date.now())
            .then(response => response.json())
            .then(data => {
                loadData(data);
            })
            .catch(error => {
                console.error('Error loading data, using fallback:', error);
                loadData(fallbackData);
            });

        function loadData(data) {
            currentData = data;
            const topPerformers = data.filter(item => item.category === 'top-performers');
            
            renderTable('top-performers-body', topPerformers, 'top-performers');
            
            // Calculate and display MPT allocation
            calculateMPTAllocation(topPerformers);
            
            // Add click handlers for sorting
            addSortHandlers();
        }

        function addSortHandlers() {
            const headers = document.querySelectorAll('th[data-column]');
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-column');
                    sortTable(column, header);
                });
            });
        }

        function sortTable(column, headerElement) {
            // Toggle sort direction if same column, otherwise start with ascending
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDirection = 'asc';
                currentSortColumn = column;
            }

            // Remove existing sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            // Add sort indicator to current column
            headerElement.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

            // Sort the data
            const sortedData = [...currentData].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle different data types
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            // Re-render tables with sorted data
            const topPerformers = sortedData.filter(item => item.category === 'top-performers');
            
            renderTable('top-performers-body', topPerformers, 'top-performers');
        }

        function renderTable(bodyId, data, tableType) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td class="ticker">${item.ticker}</td>
                    <td>${item.exDivDay}</td>
                    <td class="${item.buyHoldReturn > 0 ? 'positive' : 'negative'}">${formatPercentage(item.buyHoldReturn)}</td>
                    <td class="${item.divCaptureReturn > 0 ? 'positive' : 'negative'}">${formatPercentage(item.divCaptureReturn)}</td>
                    <td><span class="strategy-chip ${item.bestStrategy === 'B&H' ? 'bh-chip' : 'dc-chip'}">${item.bestStrategy}</span></td>
                    <td class="${item.bestReturn > 0 ? 'positive' : 'negative'}">${formatPercentage(item.bestReturn)}</td>
                    <td>${formatPercentage(item.dcWinRate)}</td>
                    <td><span class="risk-tag">${formatPercentage(item.riskVolatility)}</span></td>
                    <td>${formatDividend(item.medianDividend)}</td>
                </tr>
            `).join('');
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function formatCurrency(value) {
            return '$' + value.toLocaleString();
        }

        function formatDividend(value) {
            return '$' + value.toFixed(3);
        }

        function calculateMPTAllocation(topPerformers) {
            if (topPerformers.length === 0) return;

            // Add cash and SPY to the mix
            const assets = [
                ...topPerformers.map(etf => ({
                    ticker: etf.ticker,
                    return: etf.bestReturn,
                    risk: etf.riskVolatility,
                    sharpe: etf.bestReturn / etf.riskVolatility
                })),
                {
                    ticker: 'CASH',
                    return: 0.045, // 4.5% annual yield
                    risk: 0.0, // 0% risk
                    sharpe: Infinity
                },
                {
                    ticker: 'SPY',
                    return: 0.12, // 12% annual return
                    risk: 0.20, // 20% risk
                    sharpe: 0.12 / 0.20
                }
            ];

            // Force 20% cash allocation
            const cashAllocation = 0.20;
            const remainingAllocation = 0.80;

            // Filter out cash for optimization of remaining 80%
            const optimizableAssets = assets.filter(asset => asset.ticker !== 'CASH');

            // Simple mean variance optimization using Sharpe ratios
            const allocation = optimizePortfolio(optimizableAssets, remainingAllocation);
            
            // Add cash allocation back
            allocation.push({
                ticker: 'CASH',
                weight: cashAllocation,
                return: 0.045,
                risk: 0.0
            });

            // Calculate portfolio metrics
            const portfolioMetrics = calculatePortfolioMetrics(allocation);

            // Display results
            displayMPTResults(allocation, portfolioMetrics);
        }

        function optimizePortfolio(assets, totalAllocation) {
            // Sort by Sharpe ratio (descending)
            const sortedAssets = [...assets].sort((a, b) => b.sharpe - a.sharpe);
            
            // Simple allocation based on Sharpe ratios with diversification constraints
            const allocation = [];
            let remainingWeight = totalAllocation;
            
            // Limit individual positions (max 25% each for diversification)
            const maxWeight = 0.25;
            
            for (let i = 0; i < sortedAssets.length && remainingWeight > 0.01; i++) {
                const asset = sortedAssets[i];
                
                // Calculate weight based on Sharpe ratio, but cap it
                let weight = Math.min(
                    (asset.sharpe / sortedAssets.reduce((sum, a) => sum + a.sharpe, 0)) * totalAllocation,
                    maxWeight,
                    remainingWeight
                );
                
                // Minimum allocation of 2% if we're including it
                if (weight > 0.02) {
                    allocation.push({
                        ticker: asset.ticker,
                        weight: weight,
                        return: asset.return,
                        risk: asset.risk,
                        sharpe: asset.sharpe
                    });
                    remainingWeight -= weight;
                }
            }
            
            // Redistribute any remaining weight proportionally
            if (remainingWeight > 0.01 && allocation.length > 0) {
                const redistributionFactor = 1 + (remainingWeight / allocation.reduce((sum, a) => sum + a.weight, 0));
                allocation.forEach(asset => {
                    asset.weight *= redistributionFactor;
                });
            }

            return allocation;
        }

        function calculatePortfolioMetrics(allocation) {
            const portfolioReturn = allocation.reduce((sum, asset) => sum + (asset.weight * asset.return), 0);
            
            // Simplified portfolio risk calculation (assuming some correlation)
            const portfolioVariance = allocation.reduce((sum, asset) => {
                return sum + Math.pow(asset.weight * asset.risk, 2);
            }, 0);
            const portfolioRisk = Math.sqrt(portfolioVariance);
            
            const sharpeRatio = portfolioRisk > 0 ? portfolioReturn / portfolioRisk : 0;

            return {
                expectedReturn: portfolioReturn,
                risk: portfolioRisk,
                sharpeRatio: sharpeRatio
            };
        }

        function displayMPTResults(allocation, metrics) {
            // Sort allocation by weight (descending)
            const sortedAllocation = allocation.sort((a, b) => b.weight - a.weight);

            // Display allocation with progress bars
            const allocationDiv = document.getElementById('portfolio-allocation');
            allocationDiv.innerHTML = sortedAllocation.map(asset => {
                const weightPercent = (asset.weight * 100).toFixed(1);
                return `
                    <div class="allocation-row">
                        <span class="allocation-name">${asset.ticker}</span>
                        <span class="allocation-percent">${weightPercent}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${weightPercent}%"></div>
                    </div>
                `;
            }).join('');

            // Display metrics in grid layout
            const metricsDiv = document.getElementById('portfolio-metrics');
            metricsDiv.innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Expected Return</div>
                    <div class="stat-value">${formatPercentage(metrics.expectedReturn)}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Portfolio Risk</div>
                    <div class="stat-value">${formatPercentage(metrics.risk)}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Sharpe Ratio</div>
                    <div class="stat-value">${metrics.sharpeRatio.toFixed(2)}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Diversification</div>
                    <div class="stat-value">${allocation.length} assets</div>
                </div>
            `;

            // Show the widget
            document.getElementById('mpt-widget').style.display = 'block';
            
            // Animate progress bars
            setTimeout(() => {
                const bars = document.querySelectorAll('.progress-fill');
                bars.forEach((bar, index) => {
                    const width = bar.style.width;
                    bar.style.width = '0%';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, index * 150);
                });
            }, 100);
        }
    </script>
</body>
</html>
